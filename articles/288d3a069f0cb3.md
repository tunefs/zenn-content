---
title: "Jetson Nanoã®rootfsã‚’read onlyã«ã—ã¦overlayfsåŒ–ã™ã‚‹"
emoji: "ğŸ’¾"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Linux", "Ubuntu"]
published: true
---
# ã¯ã˜ã‚ã«

Jetson Nanoã®rootfsã‚’read onlyã«ã—ã¦overlayfsåŒ–ã™ã‚‹ã“ã¨ã§ã€shutdownã›ãšã«é›»æºOFFã—ã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒå£Šã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚Jetson Nanoã‚’è£…ç½®ã«çµ„ã¿è¾¼ã‚“ã§ä½¿ã†ã¨ãã«ã¯ãœã²å®Ÿæ–½ã—ã¦ãŠããŸã„ã€‚

Jetson Nanoç”¨ã®å…¬å¼SDã‚«ãƒ¼ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯Ubuntuãªã®ã§ã€`apt install overlayroot`ã—ã¦`/etc/overlayroot.conf`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã‚‹ã¨æ€ã£ãŸã®ã ãŒã€Jetson Nanoã®å ´åˆã¯è¿½åŠ è¨­å®šãŒå¿…è¦ã ã£ãŸã®ã§ãã®ã¾ã¨ã‚ã€‚

# ã¾ãšã¯åˆæœŸè¨­å®š

[ã“ã®æ‰‹é †](https://developer.nvidia.com/embedded/learn/get-started-jetson-nano-devkit)ã«å¾“ã£ã¦åˆæœŸè¨­å®šã‚’çµ‚ãˆã‚‹ã€‚

# aptæ›´æ–°

åˆæœŸè¨­å®šæ™‚ã«è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§loginã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹ã€‚
```
$ sudo -i
# apt update
# apt upgrade
# apt autoremove
```

# overlayrootã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š

```
# apt install overlayroot
```
`/etc/overlayroot.conf`ã‚’æ›¸ãæ›ãˆã‚‹ã€‚
```diff
--- a/etc/overlayroot.conf    2018-09-20 22:29:41.000000000 +0900
+++ b/etc/overlayroot.conf    2021-01-19 14:17:16.061256571 +0900
@@ -167,4 +167,4 @@
 #    The result is stored in r-------- /dev/.initramfs/overlayroot.XXXXXXX,
 #    which is a tmpfs in memory.
 overlayroot_cfgdisk="disabled"
-overlayroot=""
+overlayroot="tmpfs"
```

# è¿½åŠ ã®è¨­å®š

`/boot/extlinux/extlinux.conf`ã‚’æ›¸ãæ›ãˆã‚‹ã€‚
```diff
--- a/boot/extlinux/extlinux.conf        2020-10-20 01:10:02.974730022 +0900
+++ b/boot/extlinux/extlinux.conf        2021-01-19 14:20:38.040217352 +0900
@@ -6,8 +6,8 @@
 LABEL primary
       MENU LABEL primary kernel
       LINUX /boot/Image
-      INITRD /boot/initrd
-      APPEND ${cbootargs} quiet root=/dev/mmcblk0p1 rw rootwait rootfstype=ext4 console=ttyS0,115200n8 console=tty0 fbcon=map:0 net.ifnames=0
+      INITRD /boot/initrd.img
+      APPEND ${cbootargs} quiet root=/dev/mmcblk0p1 ro rootwait rootfstype=ext4 console=ttyS0,115200n8 console=tty0 fbcon=map:0 net.ifnames=0

 # When testing a custom kernel, it is recommended that you create a backup of
 # the original kernel and add a new entry to this file so that the device can
```

`reboot`ã™ã‚‹ã¨å®Œæˆã€‚

```
# reboot
```

# çµæœ

overlayrootå‰ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚
```
$ mount
  :
/dev/mmcblk0p1 on / type ext4 (rw,relatime,data=ordered)
  :
```

overlayrootå¾Œã¯`/`ãŒ`overlay`ã«ãªã£ã¦ã€`/dev/mmcblk0p1`ãŒ`/media/root-ro`ã«`ro`ã§`mount`ã•ã‚Œã¦ã„ã‚‹ã€‚
```
$ mount
  :
/dev/mmcblk0p1 on /media/root-ro type ext4 (ro,relatime,data=ordered)
  :
overlayroot on / type overlay (rw,relatime,lowerdir=/media/root-ro,upperdir=/media/root-rw/overlay,workdir=/media/root-rw/overlay-workdir/_)
  :
```

# rootfså†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆãŸã„ã¨ã

`overlayroot-chroot`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`/`ãŒ`rw`ã«ãªã£ã¦æ›¸ãæ›ãˆã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```
$ sudo overlayroot-chroot
# mount
  :
/dev/mmcblk0p1 on / type ext4 (rw,relatime,data=ordered)
  :
```

`chroot`ç’°å¢ƒã‹ã‚‰`exit`ã™ã‚‹ã¨å…ƒã®readonly + overlayfsã«æˆ»ã‚‹ã€‚
```
# exit
$
```
