---
title: "ã‚ã‚‹ç‚¹ã«æœ€ã‚‚è¿‘ã„ãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹ã‚’æ±‚ã‚ã‚‹"
emoji: "ðŸ“ˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["javascript", "graphics"]
published: true
---
# ã¯ã˜ã‚ã«

3æ¬¡ãƒ™ã‚¸ã‚§æ›²ç·šã‚’æ‰±ã†ã“ã¨ã«ãªã‚Šã€ã‚ã‚‹ç‚¹ã«æœ€ã‚‚è¿‘ã„ãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹ã‚’è¨ˆç®—ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§JavaScriptã§æ›¸ã„ã¦ã¿ãŸã€‚

# ãƒ™ã‚¸ã‚§æ›²ç·š

ãƒ™ã‚¸ã‚§æ›²ç·šã¯[Wikipedia](https://en.wikipedia.org/wiki/BÃ©zier_curve)ã§èª¬æ˜Žã•ã‚Œã¦ã„ã‚‹é€šã‚Šã§ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã©ã§ä½¿ã‚ã‚Œã‚‹ãƒ‘ãƒ©ãƒ¡ãƒˆãƒªãƒƒã‚¯æ›²ç·šã®ã²ã¨ã¤ã€‚ä»Šå›žã¯3æ¬¡ãƒ™ã‚¸ã‚§æ›²ç·šãªã®ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’tã¨ã™ã‚‹ã¨ãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹ã¯ä¸‹è¨˜å¼ã§è¡¨ã™ã“ã¨ãŒã§ãã‚‹ã€‚

$$
B(t) = (1 - t)^3P_0 + 3(1 - t)^2 tP_1 + 3(1 - t)t^2 P_2 + t^3 P_3
$$

# ã‚ã‚‹ç‚¹ã«æœ€ã‚‚è¿‘ã„ãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹

ãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹ã®æŽ¥ç·šï¼ˆãƒ™ã‚¸ã‚§æ›²ç·šã®å¾®åˆ†ï¼‰ã¨ã€ç‚¹Pã‹ã‚‰ãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹ã¸ã®ãƒ™ã‚¯ãƒˆãƒ«ãŒåž‚ç›´ã«ãªã‚‹ç‚¹ãŒã€ç‚¹Pã«æœ€ã‚‚è¿‘ã„ãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹ã«ãªã‚‹ã€‚

ãƒ™ã‚¸ã‚§æ›²ç·šã®å¾®åˆ†ã‚‚[Wikipedia](https://en.wikipedia.org/wiki/BÃ©zier_curve)ã§èª¬æ˜Žã•ã‚Œã¦ã„ã‚‹é€šã‚Šã€‚

$$
B'(t) = 3(1 - t)^2 (P_1 - P_0) + 6(1 - t)t(P_2 - P_1) + 3t^2 (P_3 - P_2)
$$

åž‚ç›´åˆ¤å®šã¯ãƒ‰ãƒƒãƒˆç©ãŒ0ã«ãªã‚Œã°OKã€‚

$$
(B(t) - P) \cdot B'(t) = 0
$$

ã“ã®tã‚’2åˆ†æŽ¢ç´¢ã§æ±‚ã‚ã¦ã¿ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚

# ãƒ™ã‚¸ã‚§æ›²ç·šã®åˆ†å‰²

ãƒ™ã‚¸ã‚§æ›²ç·šã®åˆ†å‰²ã«ã¤ã„ã¦ã¯ã€[ãƒ™ã‚¸ã‚¨æ›²ç·šã®é•·ã•ã‚’æ±‚ã‚ã‚‹](https://qiita.com/Satachito/items/f084c523a62578c5fd36#ãƒ™ã‚¸ã‚¨æ›²ç·šã®åˆ†å‰²-1)ã«æ›¸ã‹ã‚Œã¦ã„ãŸã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ã£ã¦ã„ã‚‹ã€‚

$P_1, P_2, P_3, P_4$ã§å®šç¾©ã•ã‚ŒãŸ3æ¬¡ãƒ™ã‚¸ã‚§æ›²ç·šã‚’$t = 0.5$ã§åˆ†å‰²ã™ã‚‹å ´åˆã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

## å‰åŠ

åˆ†å‰²ã—ã¦ã§ãã‚‹å‰åŠã®æ–°ã—ã„ãƒ™ã‚¸ã‚§æ›²ç·šã®å§‹ç‚¹ã€åˆ¶å¾¡ç‚¹1ã€åˆ¶å¾¡ç‚¹2ã€çµ‚ç‚¹ã¯ä¸‹è¨˜ã€‚

$$
P_0
$$
$$
\frac{(P_0 + P_1)}{2}
$$
$$
\frac{P_0 + 2P_1 + P_2}{4}
$$
$$
\frac{P_0 + 3P_1 + 3P_2 + P_3}{8}
$$

## å¾ŒåŠ

åˆ†å‰²ã—ã¦ã§ãã‚‹å¾ŒåŠã®æ–°ã—ã„ãƒ™ã‚¸ã‚§æ›²ç·šã®å§‹ç‚¹ã€åˆ¶å¾¡ç‚¹1ã€åˆ¶å¾¡ç‚¹2ã€çµ‚ç‚¹ã¯ä¸‹è¨˜ã€‚

$$
\frac{P_0 + 3P_1 + 3P_2 + P_3}{8}
$$
$$
\frac{P_1 + 2P_2 + P_3}{4}
$$
$$
\frac{(P_2 + P_3)}{2}
$$
$$
P_3
$$

# æŽ¢ç´¢æ–¹æ³•

~~ãƒ™ã‚¸ã‚§æ›²ç·šã‚’åˆ†å‰²ã—ãªãŒã‚‰ã€é©å½“ãªtï¼ˆã¨ã‚Šã‚ãˆãš0.5ï¼‰ã§æ±‚ã‚ãŸãƒ™ã‚¸ã‚§æ›²ç·šä¸Šã®ç‚¹ã®æŽ¥ç·šã¨ã‚ã‚‹ç‚¹ã¨ã®ç›´ç·šãŒåž‚ç›´ã‹ï¼ˆãƒ‰ãƒƒãƒˆç©ãŒ0ã‹ï¼‰èª¿ã¹ã€ãƒ‰ãƒƒãƒˆç©ã®å€¤ã‹ã‚‰æ¬¡ã®åˆ†å‰²ä½ç½®ã‚’æ±ºã‚ã¦å†å¸°ã€ãƒ™ã‚¸ã‚§æ›²ç·šã®é•·ã•ãŒå°ã•ããªã‚Œã°ãã®ãƒ™ã‚¸ã‚§æ›²ç·šåŒºé–“ã®$t=0.5$ã‚’æŽ¢ç´¢ç‚¹ã¨ã™ã‚‹æ–¹æ³•ã«ã—ã¦ã¿ãŸã€‚~~

ã“ã‚Œã ã¨ã“ã‚“ãªãƒ™ã‚¸ã‚§æ›²ç·šã ã¨ã†ã¾ãå‹•ä½œã—ãªã‹ã£ãŸã€‚
![](/images/124bcb5966c4a7/ng.png)

åˆ¥ã®æ–¹æ³•ã¨ã—ã¦ã€$t=0.5$ã§ãƒ™ã‚¸ã‚§æ›²ç·šã‚’åˆ†å‰²ã—ã¦ã€ãƒ™ã‚¸ã‚§æ›²ç·šã‚’å†…åŒ…ã™ã‚‹çŸ©å½¢ã®å„è¾ºã¨ã‚ã‚‹ç‚¹ã¨ã®è·é›¢ã‚’æ±‚ã‚ã¦ã€åˆ†å‰²ã—ãŸãƒ™ã‚¸ã‚§æ›²ç·šï¼ˆã‚’å†…åŒ…ã™ã‚‹çŸ©å½¢ï¼‰ã®ã©ã¡ã‚‰ãŒã‚ã‚‹ç‚¹ã«è¿‘ã„ã‹ã‚’èª¿ã¹ã€ãƒ™ã‚¸ã‚§æ›²ç·šã®é•·ã•ãŒçŸ­ããªã‚‹ã¾ã§å†å¸°ã™ã‚‹æ–¹æ³•ã«ã—ã¦ã¿ãŸã€‚

# ç›´ç·šã¨ç‚¹ã¨ã®è·é›¢

çŸ©å½¢ã®å„è¾ºã¨ã‚ã‚‹ç‚¹ã¨ã®è·é›¢ã¯[ç‚¹ã¨ç·šåˆ†ã®è·é›¢ã‚’æ±‚ã‚ã‚‹](https://zenn.dev/boiledorange73/articles/0037-js-distance-pt-seg)ã‚’å‚è€ƒã«ä¸‹è¨˜ã§æ±‚ã‚ã‚‹ã“ã¨ã«ã—ãŸã€‚

$$
d2(\overline{t}) = \frac{(a(y1-y0)-b(x1-x0))^2}{a^2+b^2}
$$

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

## ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

ãƒ™ã‚¯ãƒˆãƒ«è¨ˆç®—ãŒæ¥½ã«ãªã‚‹ã‚ˆã†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’ç”¨æ„ã™ã‚‹ã€‚`add`ã¯å’Œã€`sub`ã¯å·®ã€`mul`ã¯è¦ç´ ã‚’`v`å€ã€`div`ã¯è¦ç´ ã‚’`1/v`ã€`dot`ã¯ãƒ‰ãƒƒãƒˆç©ã€`norm_squared`ã¯ãƒ™ã‚¯ãƒˆãƒ«ã®é•·ã•ã®äºŒä¹—ã€‚

```js
const add = (a, b) => [a[0] + b[0], a[1] + b[1]];

const sub = (a, b) => [a[0] - b[0], a[1] - b[1]];

const mul = (a, v) => a.map(i => i * v);

const div = (a, v) => a.map(i => i / v);

const dot = (a, b) => a[0] * b[0] + a[1] * b[1];

const norm_squared = a => dot(a, a);
```

## ãƒ™ã‚¸ã‚§æ›²ç·šé–¢é€£

### æ›²ç·šä¸Šã®ç‚¹

æ›²ç·šä¸Šã®ç‚¹ã®æ•°å¼ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã—ãŸã‚‚ã®ã€‚å¼•æ•°ã®`t`ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€`bz`ã¯4è¦ç´ é…åˆ—ã§å®šç¾©ã—ãŸ3æ¬¡ãƒ™ã‚¸ã‚§æ›²ç·šã€‚

```js
const completion = (t, bz) => {
  const t_ = 1 - t;
  return add(add(add(mul(bz[0], t_ * t_ * t_),
                     mul(bz[1], 3 * t_ * t_ * t)),
                     mul(bz[2], 3 * t_ * t * t)),
                     mul(bz[3], t * t * t));
};
```

### æŽ¥ç·š

å¾®åˆ†ã®æ•°å¼ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã—ãŸã‚‚ã®ã€‚

```js
const differential = (t, bz) => {
  const t_ = 1 - t;
  return add(add(mul(sub(bz[1], bz[0]), 3 * t_ * t_),
                 mul(sub(bz[2], bz[1]), 6 * t_ * t)),
                 mul(sub(bz[3], bz[2]), 3 * t * t));
};
```

### åˆ†å‰²

åˆ†å‰²ã®æ•°å¼ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã—ãŸã‚‚ã®ã€‚$t=0.5$ã§åˆ†å‰²ã—ã¦åˆ†å‰²å¾Œã®ãƒ™ã‚¸ã‚§æ›²ç·šã‚’é…åˆ—ã§è¿”ã™ã€‚

```js
const split_bezier = bz => {
  const center = completion(0.5, bz);
  return [
    [
      bz[0],
      div(add(bz[0], bz[1]), 2),
      div(add(add(bz[0], mul(bz[1], 2)), bz[2]), 4),
      center
    ],
    [
      center,
      div(add(add(bz[1], mul(bz[2], 2)), bz[3]), 4),
      div(add(bz[2], bz[3]), 2),
      bz[3]
    ]
  ];
};
```
## ç›´ç·šã¨ç‚¹ã¨ã®è·é›¢ï¼ˆã®äºŒä¹—ï¼‰

```js
const diff2_to_line = (line, p) => {
  const ps = sub(line[0], p);
  const [a, b] = sub(line[1], line[0]);
  const n2 = norm_squared([a, b]);
  const tt = -(a * ps[0] + b * ps[1]);
  if (tt < 0)
    return norm_squared(ps);
  else if (tt > n2)
    return norm_squared(sub(line[1], p));
  const f1 = a * ps[1] - b * ps[0];
  return f1 * f1 / n2;
};
```

## ãƒ™ã‚¸ã‚§æ›²ç·šã‚’å†…åŒ…ã™ã‚‹çŸ©å½¢ã¨ç‚¹ã¨ã®è·é›¢ï¼ˆã®äºŒä¹—ï¼‰

3æ¬¡ãƒ™ã‚¸ã‚§æ›²ç·šã‚’æ§‹æˆã™ã‚‹4ç‚¹ã§ä½œã‚‰ã‚Œã‚‹çŸ©å½¢ã®å„è¾ºã«ã¤ã„ã¦é•·ã•ã‚’æ±‚ã‚ãã‚Œã‚‰ã®æœ€çŸ­ã‚’æ±‚ã‚ã¦ã„ã‚‹ã€‚

```js
const diff2_to_polygon = (bz, p) => {
  return Math.min(
    diff2_to_line([bz[0], bz[1]], p),
    diff2_to_line([bz[1], bz[2]], p),
    diff2_to_line([bz[2], bz[3]], p),
    diff2_to_line([bz[3], bz[0]], p)
  );
};
```

## æŽ¢ç´¢å‡¦ç†

`bz`ã¯ãƒ™ã‚¸ã‚§æ›²ç·šã€`p`ã¯ã‚ã‚‹ç‚¹ã€`t0`ã¨`t1`ã¯æŽ¢ç´¢åŒºé–“ã‚’è¡¨ã™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å€¤ã€‚

åˆ†å‰²ã—ãŸ2ã¤ã®ãƒ™ã‚¸ã‚§æ›²ç·šã«ã¤ã„ã¦è·é›¢ãŒçŸ­ã„æ–¹ã«ã¤ã„ã¦å†å¸°ã—ãªãŒã‚‰ã•ã‚‰ã«åˆ†å‰²ã—ã€ãƒ™ã‚¸ã‚§æ›²ç·šã®é•·ã•ãŒçŸ­ããªã‚‹ã¨å†å¸°ã‚’çµ‚ãˆã‚‹ã€‚

```js
const done_or_recursive = (bz, p, t0, t1) => {
  const n2 = norm_squared(sub(bz[3], bz[0]));
  if (n2 < 1 * 1)
    return (t0 + t1) * 0.5;
  return neighbor_bezier(bz, p, t0, t1);
};

const neighbor_bezier = (bz, p, t0, t1) => {
  const splitbz = split_bezier(bz);
  const d0 = diff2_to_polygon(splitbz[0], p);
  const d1 = diff2_to_polygon(splitbz[1], p);
  const tcenter = (t0 + t1) * 0.5;
  return d0 < d1
    ? done_or_recursive(splitbz[0], p, t0, tcenter)
    : done_or_recursive(splitbz[1], p, tcenter, t1);
};
```

## å‹•ã‹ã—ã¦ã¿ã‚‹

ã“ã‚“ãªãƒ™ã‚¸ã‚§æ›²ç·šã§å‹•ã‹ã—ã¦ã¿ãŸã€‚

```js
const bezier = [
  [ 50,  50],
  [ 50, 300],
  [550, 300],
  [550, 550]
];
```
Canvasã§Yè»¸ãŒé€†ã ã‘ã©å›³ã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã€‚
![](/images/124bcb5966c4a7/bezier.png)

ä¸Šã«æŒ™ã’ãŸã†ã¾ãå‹•ä½œã—ãªã‹ã£ãŸãƒ™ã‚¸ã‚§æ›²ç·šã‚‚OKã€‚

```js
const bezier = [
  [150, 550],
  [ 50,  50],
  [550,  50],
  [250, 550]
];
```

![](/images/124bcb5966c4a7/ok.png)


# ãƒªãƒã‚¸ãƒˆãƒª

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸€å¼ã¯ã“ã¡ã‚‰ã€‚
https://github.com/tunefs/neighbor_bezier

# ãƒ‡ãƒ¢

Canvasä½¿ã£ã¦ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ãŸã€‚
https://tunefs.github.io/neighbor_bezier/
